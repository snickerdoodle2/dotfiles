#!/usr/bin/env python3

import os
import subprocess
import sys

os.system("tmux start-server")

available = ["Create New Session"] + list(filter(
        lambda x: len(x) > 0,
        subprocess \
            .check_output(["tmux", "ls", "-F" "#{session_name}"]) \
            .decode("utf-8") \
            .split("\n")
        ))

echo = subprocess.Popen(["echo" , "\n".join(available)], stdout=subprocess.PIPE)
selected_ = subprocess.Popen(["fzf"], stdin=echo.stdout, stdout=subprocess.PIPE)
selected_.wait()

if selected_.stdout is not None:
    selected = selected_.stdout.read().decode("utf-8").strip("\n")

    if selected == "Create New Session":
        base = os.path.basename(os.getcwd())

        if base in available:
            print("Session already exists", file=sys.stderr)
            sys.exit(1)

        os.system(f"tmux new-session -ds {base} -c $PWD")
        name = base
    else:
        name = selected

    if "TMUX" in os.environ:
        os.system(f"tmux switch-client -t {name}")
    else:
        os.system(f"tmux attach -t {name}")
